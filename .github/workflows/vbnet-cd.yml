name: VB.NET CD to Azure VM

on:
  workflow_run:
    workflows: ["VB.NET CI"]
    types: [completed]
    branches: [main, master]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: 'dev'
      artifact-run-id:
        description: 'CI run ID to deploy from (leave empty to use latest)'
        required: false

env:
  DEPLOYMENT_SCRIPT_PATH: 'src/VBNetApp/deployment/deploy.ps1'

jobs:
  deploy:
    name: Deploy to Azure Windows VM
    runs-on: windows-latest
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}
      url: ${{ steps.deploy-vm.outputs.app-url }}

    # Only run if CI workflow succeeded or manual dispatch
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine deployment environment
        id: determine-env
        shell: pwsh
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_ENVIRONMENT: ${{ github.event.inputs.environment }}
        run: |
          # Determine environment based on trigger
          if ($env:EVENT_NAME -eq "workflow_dispatch") {
            $deployEnv = $env:INPUT_ENVIRONMENT
          } else {
            # Default to dev for workflow_run triggers
            $deployEnv = "dev"
          }

          echo "environment=$deployEnv" >> $env:GITHUB_OUTPUT
          Write-Host "Deploying to environment: $deployEnv"

      - name: Load environment configuration
        id: load-config
        shell: pwsh
        run: |
          # Load environment-specific configuration
          $config = Get-Content -Path ".github/config/environments.yml" -Raw
          Write-Host "Environment configuration loaded"

          # Note: In a real workflow, you would parse YAML and extract values
          # For this POC, we'll use Key Vault values directly

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Fetch secrets from Azure Key Vault
        id: keyvault
        shell: pwsh
        env:
          KEY_VAULT_NAME: ${{ secrets.KEY_VAULT_NAME }}
        run: |
          $vmName = az keyvault secret show --vault-name $env:KEY_VAULT_NAME --name "vm-name" --query "value" -o tsv
          $vmResourceGroup = az keyvault secret show --vault-name $env:KEY_VAULT_NAME --name "vm-resource-group" --query "value" -o tsv
          echo "::add-mask::$vmName"
          echo "::add-mask::$vmResourceGroup"
          echo "vm-name=$vmName" >> $env:GITHUB_OUTPUT
          echo "vm-resource-group=$vmResourceGroup" >> $env:GITHUB_OUTPUT

      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package-${{ github.event.workflow_run.head_sha || github.sha }}
          path: ./deployment-artifacts
          # Note: For workflow_run, this downloads from the triggering workflow
          # For workflow_dispatch, you may need to specify run-id

      - name: Verify deployment package
        shell: pwsh
        run: |
          Write-Host "Verifying deployment package..."
          $package = Get-ChildItem -Path "./deployment-artifacts" -Filter "*.zip" -File | Select-Object -First 1

          if (-not $package) {
            Write-Error "Deployment package not found!"
            exit 1
          }

          Write-Host "Package found: $($package.Name)"
          Write-Host "Package size: $([math]::Round($package.Length / 1MB, 2)) MB"
          Write-Host "Full path: $($package.FullName)"

          # Set package path for next step
          echo "PACKAGE_PATH=$($package.FullName)" >> $env:GITHUB_ENV

      - name: Deploy to Azure VM
        id: deploy-vm
        uses: ./.github/actions/azure-vm-deploy
        with:
          keyvault-name: ${{ secrets.KEY_VAULT_NAME }}
          vm-name: ${{ steps.keyvault.outputs.vm-name }}
          resource-group: ${{ steps.keyvault.outputs.vm-resource-group }}
          deployment-package-path: ${{ env.PACKAGE_PATH }}
          deployment-script-path: ${{ env.DEPLOYMENT_SCRIPT_PATH }}
          iis-site-name: 'Default Web Site'
          iis-app-name: 'VBNetApp'
          iis-app-pool: 'VBNetAppPool'
          environment: ${{ steps.determine-env.outputs.environment }}

      - name: Deployment summary
        shell: pwsh
        env:
          DEPLOY_ENV: ${{ steps.determine-env.outputs.environment }}
          VM_NAME: ${{ steps.keyvault.outputs.vm-name }}
          VM_RESOURCE_GROUP: ${{ steps.keyvault.outputs.vm-resource-group }}
          DEPLOY_STATUS: ${{ steps.deploy-vm.outputs.deployment-status }}
          APP_URL: ${{ steps.deploy-vm.outputs.app-url }}
        run: |
          "### VB.NET Deployment Completed!" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "**Environment:** $($env:DEPLOY_ENV)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "**VM:** $($env:VM_NAME)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "**Resource Group:** $($env:VM_RESOURCE_GROUP)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "**Status:** $($env:DEPLOY_STATUS)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "**Application URL:** $($env:APP_URL)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "**Deployment Method:** Azure VM Run Command (no WinRM required)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

      - name: Notify on failure
        if: failure()
        shell: pwsh
        run: |
          Write-Error "Deployment failed! Check the logs above for details."
          "### Deployment Failed" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "Please check the workflow logs for error details." | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
